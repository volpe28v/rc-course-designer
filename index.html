<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ラジコンコースデザイナー</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0a0a0f;
            color: #00ff9d;
            background-image: 
                linear-gradient(45deg, #0a0a0f 25%, transparent 25%),
                linear-gradient(-45deg, #0a0a0f 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #0a0a0f 75%),
                linear-gradient(-45deg, transparent 75%, #0a0a0f 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            overscroll-behavior: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            position: relative;
            z-index: 1;
            
            @media (max-width: 1024px) {
                flex-direction: column;
                padding: 10px;
            }
        }

        .container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(0,255,157,0.1) 0%, rgba(0,157,255,0.1) 100%);
            pointer-events: none;
            z-index: -1;
        }

        .design-area {
            flex: 1;
            min-height: 60vh;
            
            @media (max-width: 1024px) {
                min-height: 50vh;
            }
        }

        .control-area {
            width: 300px;
            
            @media (max-width: 1024px) {
                width: 100%;
            }
        }

        .course-area {
            background: rgba(20, 20, 30, 0.9);
            border-radius: 10px;
            padding: 20px;
            height: calc(100vh - 80px);
            position: relative;
            box-shadow: 0 0 20px rgba(0,255,157,0.2),
                        inset 0 0 20px rgba(0,255,157,0.1);
            border: 1px solid rgba(0,255,157,0.3);
            overflow: auto;
            min-width: 300px;
            touch-action: none;
            -webkit-overflow-scrolling: touch;
            
            @media (max-width: 1024px) {
                height: 50vh;
                min-width: auto;
            }
        }

        .tile {
            width: 120px;
            height: 90px;
            background: rgba(0, 157, 255, 0.2);
            border: 2px solid rgba(0, 255, 157, 0.5);
            border-radius: 5px;
            position: absolute;
            cursor: move;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: transform 0.3s ease, left 0.01s, top 0.01s;
            backdrop-filter: blur(5px);
            z-index: 10;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        .tile:hover {
            box-shadow: 0 0 15px rgba(0,255,157,0.4);
            border-color: rgba(0,255,157,0.8);
        }

        .tile.dragging {
            opacity: 0.8;
            box-shadow: 0 0 20px rgba(0,255,157,0.3);
            z-index: 1000;
        }

        .controls {
            background: rgba(20, 20, 30, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,255,157,0.2);
            border: 1px solid rgba(0,255,157,0.3);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .button-group button {
            flex: 1;
        }

        .add-tile-button {
            background: rgba(0, 255, 157, 0.2);
            color: #00ff9d;
            border: 1px solid rgba(0, 255, 157, 0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .add-tile-button:hover {
            background: rgba(0, 255, 157, 0.3);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.4);
        }

        .import-button {
            background: rgba(0, 157, 255, 0.2);
            color: #00d9ff;
            border: 1px solid rgba(0, 157, 255, 0.3);
        }

        .import-button:hover {
            background: rgba(0, 157, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 157, 255, 0.4);
        }

        .textarea-container {
            display: flex;
            margin-top: 15px;
            width: 100%;
        }

        textarea.import-code {
            width: 100%;
            height: 120px;
            background: rgba(10, 10, 15, 0.9);
            color: #00d9ff;
            border: 1px solid rgba(0, 157, 255, 0.3);
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            font-size: 14px;
            
            @media (max-width: 768px) {
                height: 100px;
                font-size: 12px;
            }
        }

        input[type="text"] {
            padding: 8px;
            border: 1px solid rgba(0,255,157,0.5);
            border-radius: 5px;
            background: rgba(10, 10, 15, 0.9);
            color: #00ff9d;
            font-family: 'Courier New', monospace;
        }

        button {
            padding: 8px 16px;
            background: rgba(0,255,157,0.2);
            color: #00ff9d;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid rgba(0,255,157,0.3);
            font-family: 'Courier New', monospace;
        }

        button:hover {
            background: rgba(0,255,157,0.3);
            box-shadow: 0 0 10px rgba(0,255,157,0.4);
        }

        .reset-button {
            background: #21262d;
            color: #8b949e;
            border: 1px solid #30363d;
        }

        .reset-button:hover {
            background: #30363d;
            color: #c9d1d9;
        }

        .saved-courses {
            background: rgba(20, 20, 30, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,255,157,0.2);
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            border: 1px solid rgba(0,255,157,0.3);
            
            @media (max-width: 1024px) {
                max-height: none;
            }
        }

        #savedCoursesList {
            @media (max-width: 1024px) {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }

            @media (max-width: 768px) {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .course-preview {
            width: 100%;
            height: 80px;
            background: rgba(10, 10, 15, 0.9);
            border-radius: 5px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: 0.3s;
            border: 1px solid rgba(0,255,157,0.2);
            
            @media (max-width: 1024px) {
                margin-bottom: 0;
            }
        }

        .course-preview:hover {
            background: rgba(0,255,157,0.1);
            box-shadow: 0 0 10px rgba(0,255,157,0.3);
        }

        .delete-button {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            color: #8b949e;
            transition: 0.2s;
        }

        .delete-button:hover {
            background: none;
            color: #c9d1d9;
        }

        .export-button {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            color: #8b949e;
            transition: 0.2s;
            margin-left: 5px;
        }

        .export-button:hover {
            background: none;
            color: #c9d1d9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: rgba(20, 20, 30, 0.95);
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            width: 500px;
            max-height: 80%;
            overflow: auto;
            box-shadow: 0 0 20px rgba(0,255,157,0.3);
            border: 1px solid rgba(0,255,157,0.3);
            position: relative;
            
            @media (max-width: 768px) {
                width: 90%;
                padding: 15px;
            }
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #8b949e;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
        }

        .close-button:hover {
            color: #c9d1d9;
        }

        .code-area {
            background: rgba(10, 10, 15, 0.9);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid rgba(0,255,157,0.2);
            color: #00ff9d;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin: 10px 0;
            max-height: 250px;
            overflow-y: auto;
            font-size: 14px;
            
            @media (max-width: 768px) {
                padding: 10px;
                font-size: 12px;
            }
        }

        .copy-button {
            background: rgba(0,255,157,0.2);
            color: #00ff9d;
            border: 1px solid rgba(0,255,157,0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
            width: 100%;
            
            @media (max-width: 768px) {
                padding: 8px;
            }
        }

        .copy-button:hover {
            background: rgba(0,255,157,0.3);
            box-shadow: 0 0 10px rgba(0,255,157,0.4);
        }

        .preview-tile {
            width: 16px;
            height: 12px;
            background: #3498db;
            border: 1px solid #2980b9;
            border-radius: 2px;
            position: absolute;
            transform-origin: center;
        }

        .saved-courses h3 {
            margin-top: 0;
        }

        .selection-box {
            position: absolute;
            border: 2px dashed rgba(0,255,157,0.5);
            background: rgba(0,255,157,0.1);
            pointer-events: none;
            z-index: 1000;
        }

        .tile.selected {
            border: 2px solid rgba(0,255,157,0.8);
            box-shadow: 0 0 20px rgba(0,255,157,0.5);
            z-index: 100;
        }

        /* スクロールバーのカスタマイズ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(10, 10, 15, 0.9);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0,255,157,0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,255,157,0.7);
        }

        /* iPadとタブレット用の調整 */
        @media (hover: none) and (pointer: coarse) {
            .tile:hover {
                transform: none;
            }
            
            .controls button {
                padding: 12px 20px;
                font-size: 16px;
            }
            
            input[type="text"] {
                padding: 12px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="design-area">
            <div class="course-area" id="courseArea"></div>
        </div>
        <div class="control-area">
            <div class="controls">
                <input type="text" id="courseName" placeholder="コース名を入力">
                <div class="button-group">
                    <button onclick="saveCourse()">保存</button>
                    <button onclick="resetTiles()" class="reset-button">初期化</button>
                    <button onclick="showImportModal()" class="import-button" title="コースをインポート">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 3L4 7h2.5v6h3V7H12L8 3z"/>
                            <path d="M13 13H3v-2H2v3h12v-3h-1v2z"/>
                        </svg>
                    </button>
                </div>
                <button onclick="addNewTile()" class="add-tile-button">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0-1A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"/>
                    </svg>
                    タイルを追加
                </button>
            </div>
            <div class="saved-courses">
                <div id="savedCoursesList"></div>
            </div>
        </div>
    </div>

    <!-- エクスポートモーダル -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeModal()">×</button>
            <h3>コースエクスポート</h3>
            <p>以下のコードをコピーして他の環境でインポートできます：</p>
            <div id="exportCode" class="code-area"></div>
            <button class="copy-button" onclick="copyExportCode()">コードをコピー</button>
        </div>
    </div>

    <!-- インポートモーダル -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeImportModal()">×</button>
            <h3>コースインポート</h3>
            <p>エクスポートされたコースデータを貼り付けてください：</p>
            <div class="textarea-container">
                <textarea id="importCode" class="import-code" placeholder="ここにエクスポートされたJSONデータを貼り付け..."></textarea>
            </div>
            <button class="copy-button import-button" onclick="importCourseFromData()">インポート</button>
        </div>
    </div>

    <script>
        let draggedTile = null;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let startTime = 0;
        let isSelecting = false;
        let selectionStart = { x: 0, y: 0 };
        let selectionBox = null;
        let selectedTiles = new Set();

        // タイルの実際の位置を計算する関数
        function getTilePosition(tile, clientX, clientY) {
            const rect = tile.getBoundingClientRect();
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        // 選択範囲の作成
        function createSelectionBox(e) {
            if (!selectionBox) {
                selectionBox = document.createElement('div');
                selectionBox.className = 'selection-box';
                document.getElementById('courseArea').appendChild(selectionBox);
            }
            const rect = document.getElementById('courseArea').getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const left = Math.min(x, selectionStart.x);
            const top = Math.min(y, selectionStart.y);
            const width = Math.abs(x - selectionStart.x);
            const height = Math.abs(y - selectionStart.y);
            
            selectionBox.style.left = `${left}px`;
            selectionBox.style.top = `${top}px`;
            selectionBox.style.width = `${width}px`;
            selectionBox.style.height = `${height}px`;
        }

        // タイルが選択範囲内にあるかチェック
        function isInSelection(tile, selectionRect) {
            const tileRect = tile.getBoundingClientRect();
            const courseRect = document.getElementById('courseArea').getBoundingClientRect();
            
            const tileLeft = tileRect.left - courseRect.left;
            const tileTop = tileRect.top - courseRect.top;
            
            return !(tileLeft + tileRect.width < selectionRect.left ||
                    tileLeft > selectionRect.left + selectionRect.width ||
                    tileTop + tileRect.height < selectionRect.top ||
                    tileTop > selectionRect.top + selectionRect.height);
        }

        // 初期タイルの作成
        function createInitialTiles() {
            const courseArea = document.getElementById('courseArea');
            const areaWidth = courseArea.clientWidth;
            const areaHeight = courseArea.clientHeight;
            const tileWidth = 120;
            const tileHeight = 90;
            const tilesPerRow = Math.floor(areaWidth / (tileWidth + 10));
            const margin = 20;
            const tailCount = 12;

            for (let i = 0; i < tailCount; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile';
                // タイルの位置を計算
                const row = Math.floor(i / tilesPerRow);
                const col = i % tilesPerRow;
                tile.style.left = `${margin + col * (tileWidth + 10)}px`;
                tile.style.top = `${margin + row * (tileHeight + 10)}px`;
                tile.dataset.rotation = '0';

                // ドラッグ開始時の処理
                tile.addEventListener('mousedown', (e) => {
                    // 既に選択されているタイルをクリックした場合は選択を維持
                    if (!e.ctrlKey && !tile.classList.contains('selected')) {
                        selectedTiles.clear();
                        document.querySelectorAll('.tile.selected').forEach(t => {
                            t.classList.remove('selected');
                        });
                    }
                    startTime = Date.now();
                    isDragging = false;
                    draggedTile = tile;
                    const pos = getTilePosition(tile, e.clientX, e.clientY);
                    offsetX = pos.x;
                    offsetY = pos.y;
                    tile.classList.add('dragging');
                    tile.classList.add('selected');
                    selectedTiles.add(tile);
                    e.stopPropagation();
                });

                // クリック時の回転処理
                tile.addEventListener('click', (e) => {
                    if (!isDragging) {
                        const currentRotation = parseInt(tile.dataset.rotation) || 0;
                        const newRotation = (currentRotation + 90) % 360;
                        tile.style.transform = `rotate(${newRotation}deg)`;
                        tile.dataset.rotation = newRotation;
                    }
                });

                courseArea.appendChild(tile);
            }

            // コースエリアのマウスイベント
            courseArea.addEventListener('mousedown', (e) => {
                if (e.target === courseArea) {
                    isSelecting = true;
                    const rect = courseArea.getBoundingClientRect();
                    selectionStart = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                    if (!e.ctrlKey) {
                        selectedTiles.clear();
                        document.querySelectorAll('.tile.selected').forEach(t => {
                            t.classList.remove('selected');
                        });
                    }
                }
            });
        }

        // ドラッグ中の処理
        document.addEventListener('mousemove', (e) => {
            if (isSelecting) {
                createSelectionBox(e);
                const rect = selectionBox.getBoundingClientRect();
                const courseRect = document.getElementById('courseArea').getBoundingClientRect();
                const selectionRect = {
                    left: rect.left - courseRect.left,
                    top: rect.top - courseRect.top,
                    width: rect.width,
                    height: rect.height
                };
                
                document.querySelectorAll('.tile').forEach(tile => {
                    if (isInSelection(tile, selectionRect)) {
                        tile.classList.add('selected');
                        selectedTiles.add(tile);
                    } else if (!e.ctrlKey) {
                        tile.classList.remove('selected');
                        selectedTiles.delete(tile);
                    }
                });
            }

            if (draggedTile) {
                if (!isDragging && 
                    (Math.abs(e.clientX - offsetX) > 1 || 
                     Math.abs(e.clientY - offsetY) > 1)) {
                    isDragging = true;
                    // 初期オフセットを記録
                    const rect = document.getElementById('courseArea').getBoundingClientRect();
                    draggedTile.dataset.initialX = e.clientX - rect.left;
                    draggedTile.dataset.initialY = e.clientY - rect.top;
                    
                    // 各タイルの相対位置を記録
                    selectedTiles.forEach(tile => {
                        tile.dataset.offsetX = parseInt(tile.style.left) - parseInt(draggedTile.style.left);
                        tile.dataset.offsetY = parseInt(tile.style.top) - parseInt(draggedTile.style.top);
                    });
                }

                if (isDragging) {
                    const courseArea = document.getElementById('courseArea');
                    const rect = courseArea.getBoundingClientRect();
                    // マウス位置から直接新しい位置を計算
                    const newX = e.clientX - rect.left - offsetX;
                    const newY = e.clientY - rect.top - offsetY;

                    // 選択されたタイルすべてを移動
                    selectedTiles.forEach(tile => {
                        const offsetX = parseInt(tile.dataset.offsetX || 0);
                        const offsetY = parseInt(tile.dataset.offsetY || 0);
                        
                        // 新しい位置を計算（範囲制限付き）
                        const newLeft = Math.max(0, Math.min(newX + offsetX, rect.width - tile.offsetWidth));
                        const newTop = Math.max(0, Math.min(newY + offsetY, rect.height - tile.offsetHeight));
                        
                        tile.style.left = `${newLeft}px`;
                        tile.style.top = `${newTop}px`;
                    });
                }
            }
        });

        // ドラッグ終了時の処理
        document.addEventListener('mouseup', () => {
            if (draggedTile) {
                draggedTile.classList.remove('dragging');
                // ドラッグ終了後も選択状態は維持
                if (!draggedTile.classList.contains('selected')) {
                    draggedTile.classList.add('selected');
                    selectedTiles.add(draggedTile);
                }
                draggedTile = null;
            }
            if (isSelecting) {
                isSelecting = false;
                if (selectionBox) {
                    selectionBox.remove();
                    selectionBox = null;
                }
            }
        });

        // コースの保存
        function saveCourse() {
            const courseName = document.getElementById('courseName').value;
            if (!courseName) {
                alert('コース名を入力してください');
                return;
            }

            const tiles = document.querySelectorAll('.tile');
            const tilePositions = Array.from(tiles).map(tile => ({
                left: tile.style.left,
                top: tile.style.top,
                rotation: tile.dataset.rotation || '0'
            }));

            const savedCourses = JSON.parse(localStorage.getItem('rcCourses') || '{}');
            savedCourses[courseName] = {
                tiles: tilePositions,
                timestamp: Date.now()
            };
            localStorage.setItem('rcCourses', JSON.stringify(savedCourses));

            updateSavedCoursesList();
        }

        // 保存済みコースの一覧を更新
        function updateSavedCoursesList() {
            const savedCourses = JSON.parse(localStorage.getItem('rcCourses') || '{}');
            const listElement = document.getElementById('savedCoursesList');
            listElement.innerHTML = '';

            // 古いデータ構造を新しい形式に変換
            Object.entries(savedCourses).forEach(([name, data]) => {
                if (!data.timestamp) {
                    savedCourses[name] = {
                        tiles: data,
                        timestamp: Date.now()
                    };
                }
            });

            // コースを登録順（タイムスタンプ順）にソート
            const sortedCourses = Object.entries(savedCourses)
                .sort((a, b) => b[1].timestamp - a[1].timestamp)
                .map(([name, data]) => ({ name, data }));

            sortedCourses.forEach(({ name: courseName, data }) => {
                const courseElement = document.createElement('div');
                courseElement.style.margin = '0';
               
                // プレビューの作成
                const previewContainer = document.createElement('div');
                previewContainer.className = 'course-preview';
                previewContainer.onclick = () => loadSpecificCourse(courseName);
                
                // タイルの位置を計算してプレビューに配置
                const courseData = data.tiles;
                const previewScale = 0.133;
                
                courseData.forEach(tileData => {
                    const previewTile = document.createElement('div');
                    previewTile.className = 'preview-tile';
                    
                    // 位置とサイズを計算
                    const left = parseInt(tileData.left) * previewScale;
                    const top = parseInt(tileData.top) * previewScale;
                    const rotation = tileData.rotation || 0;
                    
                    previewTile.style.left = `${left}px`;
                    previewTile.style.top = `${top}px`;
                    previewTile.style.transform = `rotate(${rotation}deg)`;
                    
                    previewContainer.appendChild(previewTile);
                });

                courseElement.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <span>${courseName}</span>
                        <div>
                            <button onclick="exportCourse('${courseName}')" class="export-button" title="エクスポート">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M8 12l-4-4h2.5V3h3v5H12L8 12z"/>
                                    <path d="M13 13H3v-2H2v3h12v-3h-1v2z"/>
                                </svg>
                            </button>
                            <button onclick="deleteCourse('${courseName}')" class="delete-button" title="削除">
                                <svg width="16" height="16" viewBox="0 0 16 16">
                                    <path fill="currentColor" d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill="currentColor" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                courseElement.appendChild(previewContainer);
                listElement.appendChild(courseElement);
            });

            // 変換したデータを保存
            localStorage.setItem('rcCourses', JSON.stringify(savedCourses));
        }

        // 特定のコースを読み込む
        function loadSpecificCourse(courseName) {
            const savedCourses = JSON.parse(localStorage.getItem('rcCourses') || '{}');
            // 古い形式と新しい形式の両方に対応
            const courseData = savedCourses[courseName].tiles || savedCourses[courseName];
            
            if (courseData) {
                const courseArea = document.getElementById('courseArea');
                courseArea.innerHTML = '';
                
                courseData.forEach((tileData, index) => {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.style.left = tileData.left;
                    tile.style.top = tileData.top;
                    tile.dataset.rotation = tileData.rotation || '0';
                    tile.style.transform = `rotate(${tileData.rotation || 0}deg)`;

                    tile.addEventListener('mousedown', (e) => {
                        // 既に選択されているタイルをクリックした場合は選択を維持
                        if (!e.ctrlKey && !tile.classList.contains('selected')) {
                            selectedTiles.clear();
                            document.querySelectorAll('.tile.selected').forEach(t => {
                                t.classList.remove('selected');
                            });
                        }
                        startTime = Date.now();
                        isDragging = false;
                        draggedTile = tile;
                        const pos = getTilePosition(tile, e.clientX, e.clientY);
                        offsetX = pos.x;
                        offsetY = pos.y;
                        tile.classList.add('dragging');
                        tile.classList.add('selected');
                        selectedTiles.add(tile);
                        e.stopPropagation();
                    });

                    // クリック時の回転処理
                    tile.addEventListener('click', (e) => {
                        if (!isDragging) {
                            const currentRotation = parseInt(tile.dataset.rotation) || 0;
                            const newRotation = (currentRotation + 90) % 360;
                            tile.style.transform = `rotate(${newRotation}deg)`;
                            tile.dataset.rotation = newRotation;
                        }
                    });

                    courseArea.appendChild(tile);
                });

                document.getElementById('courseName').value = courseName;
            }
        }

        // コースの削除
        function deleteCourse(courseName) {
            const savedCourses = JSON.parse(localStorage.getItem('rcCourses') || '{}');
            delete savedCourses[courseName];
            localStorage.setItem('rcCourses', JSON.stringify(savedCourses));
            updateSavedCoursesList();
        }

        // タイルを初期位置に戻す
        function resetTiles() {
            const courseArea = document.getElementById('courseArea');
            courseArea.innerHTML = '';
            selectedTiles.clear();
            document.getElementById('courseName').value = '';
            createInitialTiles();
        }

        // 初期化
        createInitialTiles();
        updateSavedCoursesList();

        // タッチイベントの処理
        let lastTap = 0;
        
        document.addEventListener('touchstart', (e) => {
            if (e.target.classList.contains('tile')) {
                e.preventDefault();
                const touch = e.touches[0];
                draggedTile = e.target;
                const pos = getTilePosition(draggedTile, touch.clientX, touch.clientY);
                offsetX = pos.x;
                offsetY = pos.y;
                draggedTile.classList.add('dragging');
                
                // ダブルタップ検出
                const now = Date.now();
                if (now - lastTap < 300) {
                    const currentRotation = parseInt(draggedTile.dataset.rotation) || 0;
                    const newRotation = (currentRotation + 90) % 360;
                    draggedTile.style.transform = `rotate(${newRotation}deg)`;
                    draggedTile.dataset.rotation = newRotation;
                    draggedTile = null;
                }
                lastTap = now;
            }
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (draggedTile) {
                e.preventDefault();
                const touch = e.touches[0];
                
                if (!isDragging) {
                    isDragging = true;
                    if (!draggedTile.classList.contains('selected')) {
                        document.querySelectorAll('.tile.selected').forEach(tile => {
                            tile.classList.remove('selected');
                        });
                        selectedTiles.clear();
                    }
                    draggedTile.classList.add('selected');
                    selectedTiles.add(draggedTile);
                }

                const courseArea = document.getElementById('courseArea');
                const rect = courseArea.getBoundingClientRect();
                const newX = touch.clientX - rect.left - offsetX;
                const newY = touch.clientY - rect.top - offsetY;

                selectedTiles.forEach(tile => {
                    const offsetX = parseInt(tile.dataset.offsetX || 0);
                    const offsetY = parseInt(tile.dataset.offsetY || 0);
                    const newLeft = Math.max(0, Math.min(newX + offsetX, rect.width - tile.offsetWidth));
                    const newTop = Math.max(0, Math.min(newY + offsetY, rect.height - tile.offsetHeight));
                    tile.style.left = `${newLeft}px`;
                    tile.style.top = `${newTop}px`;
                });
            }
        }, { passive: false });

        document.addEventListener('touchend', () => {
            if (draggedTile && isDragging) {
                draggedTile.classList.remove('dragging');
                draggedTile = null;
                isDragging = false;
            }
        });

        // コースをエクスポート
        function exportCourse(courseName) {
            const savedCourses = JSON.parse(localStorage.getItem('rcCourses') || '{}');
            const courseData = savedCourses[courseName];
            
            if (!courseData) return;
            
            // エクスポート用のデータ形式
            const exportData = {
                name: courseName,
                data: courseData
            };
            
            const exportCode = JSON.stringify(exportData, null, 2);
            
            document.getElementById('exportCode').textContent = exportCode;
            document.getElementById('exportModal').style.display = 'flex';
        }
        
        // モーダルを閉じる
        function closeModal() {
            document.getElementById('exportModal').style.display = 'none';
        }
        
        // インポートモーダルを表示
        function showImportModal() {
            document.getElementById('importCode').value = '';
            document.getElementById('importModal').style.display = 'flex';
        }
        
        // インポートモーダルを閉じる
        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }
        
        // コースデータをインポート
        function importCourseFromData() {
            const importText = document.getElementById('importCode').value.trim();
            
            if (!importText) {
                alert('インポートするデータを入力してください');
                return;
            }
            
            try {
                // JSONデータをパース
                const importData = JSON.parse(importText);
                
                if (!importData.name || !importData.data) {
                    throw new Error('無効なコースデータ形式です');
                }
                
                // 既存のコースデータを取得
                const savedCourses = JSON.parse(localStorage.getItem('rcCourses') || '{}');
                
                // 同名のコースが存在する場合は確認
                if (savedCourses[importData.name] && !confirm(`"${importData.name}"は既に存在します。上書きしますか？`)) {
                    return;
                }
                
                // コースを追加
                savedCourses[importData.name] = importData.data;
                
                // 保存
                localStorage.setItem('rcCourses', JSON.stringify(savedCourses));
                
                // リストを更新
                updateSavedCoursesList();
                
                // モーダルを閉じる
                closeImportModal();
                
                // インポートしたコースを読み込む
                loadSpecificCourse(importData.name);
                
            } catch (error) {
                alert('インポートに失敗しました: ' + error.message);
            }
        }
        
        // エクスポートコードをコピー
        function copyExportCode() {
            const codeElement = document.getElementById('exportCode');
            const textArea = document.createElement('textarea');
            textArea.value = codeElement.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }
        
        // モーダル外をクリックしたら閉じる
        window.onclick = function(event) {
            const exportModal = document.getElementById('exportModal');
            const importModal = document.getElementById('importModal');
            
            if (event.target === exportModal) {
                exportModal.style.display = 'none';
            }
            
            if (event.target === importModal) {
                importModal.style.display = 'none';
            }
        }

        // 新しいタイルを追加
        function addNewTile() {
            const courseArea = document.getElementById('courseArea');
            const tile = document.createElement('div');
            tile.className = 'tile';
            
            // 中央付近に配置
            const centerX = (courseArea.clientWidth / 2) - 60;
            const centerY = (courseArea.clientHeight / 2) - 45;
            tile.style.left = `${centerX}px`;
            tile.style.top = `${centerY}px`;
            tile.dataset.rotation = '0';

            // ドラッグ開始時の処理
            tile.addEventListener('mousedown', (e) => {
                // 既に選択されているタイルをクリックした場合は選択を維持
                if (!e.ctrlKey && !tile.classList.contains('selected')) {
                    selectedTiles.clear();
                    document.querySelectorAll('.tile.selected').forEach(t => {
                        t.classList.remove('selected');
                    });
                }
                startTime = Date.now();
                isDragging = false;
                draggedTile = tile;
                const pos = getTilePosition(tile, e.clientX, e.clientY);
                offsetX = pos.x;
                offsetY = pos.y;
                tile.classList.add('dragging');
                tile.classList.add('selected');
                selectedTiles.add(tile);
                e.stopPropagation();
            });

            // クリック時の回転処理
            tile.addEventListener('click', (e) => {
                if (!isDragging) {
                    const currentRotation = parseInt(tile.dataset.rotation) || 0;
                    const newRotation = (currentRotation + 90) % 360;
                    tile.style.transform = `rotate(${newRotation}deg)`;
                    tile.dataset.rotation = newRotation;
                }
            });

            courseArea.appendChild(tile);
            
            // 新しいタイルを選択状態に
            selectedTiles.clear();
            document.querySelectorAll('.tile.selected').forEach(t => {
                t.classList.remove('selected');
            });
            tile.classList.add('selected');
            selectedTiles.add(tile);
        }
    </script>
</body>
</html> 